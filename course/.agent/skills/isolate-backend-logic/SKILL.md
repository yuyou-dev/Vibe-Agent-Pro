---
name: Middleware Logic Isolation (BFF Pattern)
description: å°†ç®€å•çš„æœ¬åœ°ä»£ç†é‡æ„ä¸ºä¸“ç”¨çš„ Node.js ä¸­é—´å±‚ï¼ˆBackend for Frontendï¼‰ï¼Œç”¨äºå°è£…æ ¸å¿ƒ AI é€»è¾‘ã€æç¤ºè¯å’Œæ•æ„Ÿé…ç½®ï¼Œä½¿å…¶ä¸å‰ç«¯å½»åº•éš”ç¦»ã€‚
version: 1.0.0
---

# ä¸­é—´å±‚é€»è¾‘éš”ç¦»ä¸æ ¸å¿ƒä¿æŠ¤ (BFFæ¨¡å¼)

æœ¬ Skill æŒ‡å¯¼ Agent å°†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å’Œæ•æ„Ÿçš„ AI æç¤ºè¯ï¼ˆPromptsï¼‰ä»å‰ç«¯å®¢æˆ·ç«¯åˆ†ç¦»ï¼Œè¿ç§»åˆ°å®‰å…¨çš„ Node.js ä¸­é—´å±‚ï¼ˆBFF - Backend for Frontendï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç¡®ä¿åœ¨é¡¹ç›®ä¸Šçº¿æ—¶ï¼Œæ²¡æœ‰ä»»ä½•çŸ¥è¯†äº§æƒï¼ˆIPï¼‰æˆ–åŸå§‹æç¤ºè¯æš´éœ²åœ¨æµè§ˆå™¨ç«¯ã€‚

## ğŸ¯ è§¦å‘æŒ‡ä»¤ (Usage Trigger)
**"å°†å½“å‰çš„ç³»ç»Ÿé‡æ„ï¼ŒæŠŠæ ¸å¿ƒ AI é€»è¾‘å’Œæç¤ºè¯éš”ç¦»åˆ°ä¸­é—´å±‚ã€‚"**

**å¼€å‘è€…æç¤ºè¯èŒƒä¾‹ï¼š**
> "åˆ†æå‰ç«¯ `geminiService.ts`ï¼Œå°†æ‰€æœ‰æç¤ºè¯å·¥ç¨‹ã€æ¨¡å‹é€‰æ‹©å’Œç³»ç»ŸæŒ‡ä»¤ç§»åŠ¨åˆ°ä¸€ä¸ªæ–°çš„ Node.js ä¸­é—´å±‚ã€‚å‰ç«¯åº”è¯¥åªå‘é€ç”¨æˆ·è¾“å…¥åˆ°ä¸“ç”¨çš„ API æ¥å£ã€‚åŒæ—¶æ›´æ–°å¯åŠ¨è„šæœ¬ä»¥è¿è¡Œè¿™ä¸ªæ–°çš„ä¸­é—´å±‚ã€‚"

## ğŸ“‹ æ ‡å‡†æ“ä½œæµç¨‹ (SOP)

### ç¬¬ä¸€é˜¶æ®µï¼šåˆ†æä¸è®¾è®¡ (Analysis & Design)
1.  **è¯†åˆ«æ•æ„Ÿé€»è¾‘**ï¼šæ‰«æå‰ç«¯æœåŠ¡æ–‡ä»¶ï¼ˆå¦‚ `services/geminiService.ts`ï¼‰ï¼ŒæŸ¥æ‰¾ï¼š
    *   ç¡¬ç¼–ç çš„æ¨¡å‹åç§°ï¼ˆå¦‚ `gemini-2.5-flash`ï¼‰ã€‚
    *   ç³»ç»ŸæŒ‡ä»¤ï¼ˆSystem Instructionsï¼‰å’Œè§’è‰²è®¾å®šï¼ˆPersonasï¼‰ã€‚
    *   å¤æ‚çš„æç¤ºè¯æ¨¡æ¿ï¼ˆPrompt Templatesï¼‰ã€‚
    *   API å¯†é’¥ä½¿ç”¨æƒ…å†µï¼ˆå¦‚æœæœ‰åœ¨å‰ç«¯ï¼‰ã€‚
2.  **å®šä¹‰ API æ¥å£**ï¼šè®¾è®¡èƒ½å¤Ÿä½“ç°ä¸šåŠ¡æ„å›¾çš„ä¸“ç”¨æ¥å£ï¼Œè€Œä¸æ˜¯é€ä¼ åŸå§‹æ¨¡å‹è°ƒç”¨ã€‚
    *   *é”™è¯¯ç¤ºèŒƒ*: `POST /api/generate { prompt: "..." }`
    *   *æ­£ç¡®åšæ³•*: `POST /api/process/cinematic-prompt { baseIdea: "..." }`

### ç¬¬äºŒé˜¶æ®µï¼šä¸­é—´å±‚å®ç° (Middleware Implementation)
1.  **åˆ›å»ºä¸­é—´å±‚æ–‡ä»¶**ï¼šåœ¨æ ¹ç›®å½•åˆ›å»º `middleware.cjs`ï¼ˆæ³¨æ„ä½¿ç”¨ `.cjs` åç¼€ä»¥å…¼å®¹ `type: "module"` çš„é¡¹ç›®ï¼‰ã€‚
2.  **è®¾ç½®æ ¸å¿ƒæœåŠ¡**ï¼šåˆå§‹åŒ– Expressï¼Œé…ç½® CORSã€BodyParser å’Œ HTTPS Agentï¼ˆç”¨äºä¸Šæ¸¸ä»£ç†ï¼‰ã€‚
3.  **å®ç°ä¸“ç”¨è·¯ç”±**ï¼š
    *   å°†ç¬¬ä¸€é˜¶æ®µè¯†åˆ«å‡ºçš„é€»è¾‘è¿ç§»åˆ°ç‰¹å®šçš„ Express è·¯ç”±ä¸­ã€‚
    *   ç¡®ä¿æ‰€æœ‰ Headerï¼ˆé‰´æƒã€Nonceã€ç­¾åï¼‰éƒ½åœ¨æœåŠ¡ç«¯ç”Ÿæˆã€‚
4.  **é”™è¯¯å¤„ç†**ï¼šå®ç°å¥å£®çš„é”™è¯¯å°è£…ï¼ˆä¸è¦å°†ä¸Šæ¸¸çš„é”™è¯¯å †æ ˆä¿¡æ¯æ³„éœ²ç»™å®¢æˆ·ç«¯ï¼‰ã€‚

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯é‡æ„ (Frontend Refactoring)
1.  **ç®€åŒ–æœåŠ¡å±‚**ï¼šé‡å†™å‰ç«¯æœåŠ¡ï¼Œä½¿å…¶ä»…è°ƒç”¨æ–°çš„ä¸­é—´å±‚æ¥å£ã€‚
2.  **ç§»é™¤æœºå¯†ä¿¡æ¯**ï¼šå½»åº•åˆ é™¤å‰ç«¯ä»£ç ä¸­çš„æ—§æç¤ºè¯å¸¸é‡ã€æ¨¡å‹åç§°å’Œä¸šåŠ¡é€»è¾‘ä»£ç ã€‚
3.  **æ›´æ–°ç±»å‹å®šä¹‰**ï¼šç¡®ä¿ TypeScript æ¥å£ä¸æ–°çš„ä¸­é—´å±‚å“åº”æ ¼å¼åŒ¹é…ã€‚

### ç¬¬å››é˜¶æ®µï¼šé›†æˆä¸éªŒè¯ (Integration & Verification)
1.  **æ›´æ–°å¯åŠ¨è„šæœ¬**ï¼šä¿®æ”¹ `start_dev.cjs`ï¼ˆæˆ–åŒç±»è„šæœ¬ï¼‰ï¼Œå°†å¯åŠ¨å‘½ä»¤æ”¹ä¸º `node middleware.cjs`ã€‚
2.  **éªŒè¯ç«¯å£**ï¼šç¡®ä¿ä¸­é—´å±‚åœ¨é¢„æœŸç«¯å£ï¼ˆå¦‚ 3005ï¼‰ä¸Šç›‘å¬ã€‚
3.  **æµè§ˆå™¨æµ‹è¯•**ï¼šè¯¦ç»†éªŒè¯ UI åŠŸèƒ½æ˜¯å¦ä¾ç„¶æ­£å¸¸å·¥ä½œï¼Œç¡®ä¿åç«¯é€»è¾‘å·²è¢«æ­£ç¡®è°ƒç”¨ã€‚

## ğŸ’¡ å…³é”®æ¨¡å¼ (Key Patterns)

### BFF æ¨¡å¼ (Backend for Frontend)
ä¸­é—´å±‚ä¸å†æ˜¯ç®€å•çš„é€ä¼ ä»£ç†ï¼Œè€Œæ˜¯ä¸º UI å®šåˆ¶çš„ API æœåŠ¡ã€‚
```javascript
// middleware.cjs
app.post('/api/process/refine', async (req, res) => {
  const { input } = req.body;
  // æ ¸å¿ƒé€»è¾‘è¢«éšè—åœ¨è¿™é‡Œ
  const prompt = `Act as a pro editor... Input: ${input}`; 
  const result = await gemini.generate(prompt);
  res.json(result);
});
```

### æ¨¡å—å…¼å®¹æ€§ (Module Compatibility)
åœ¨ `package.json` ä¸º `"type": "module"` çš„ Vite/React é¡¹ç›®ä¸­å·¥ä½œæ—¶ï¼Œä¸­é—´å±‚æ–‡ä»¶åŠ¡å¿…ä½¿ç”¨ `.cjs` åç¼€ï¼Œä»¥é¿å…ä½¿ç”¨æ ‡å‡† Node.js è„šæœ¬ï¼ˆå¦‚ `require()`ï¼‰æ—¶å‡ºç°å¯¼å…¥é”™è¯¯ã€‚

## âš ï¸ æ•…éšœæ’æŸ¥ (Troubleshooting)
*   **è¿æ¥è¢«æ‹’ç» (Connection Refused)**ï¼šæ£€æŸ¥ `start_dev.cjs` æ˜¯å¦æŒ‡å‘äº†æ­£ç¡®çš„æ–‡ä»¶åï¼ˆ`middleware.cjs`ï¼‰ã€‚
*   **æ¨¡å—é”™è¯¯ (Module Errors)**ï¼šç¡®ä¿åœ¨ `.cjs` æ–‡ä»¶ä¸­ä½¿ç”¨ `require()` è€Œä¸æ˜¯ `import`ã€‚
*   **è·¨åŸŸé—®é¢˜ (CORS)**ï¼šä¸­é—´å±‚å¿…é¡»æ˜¾å¼å…è®¸å‰ç«¯æºï¼ˆOriginï¼‰çš„è¯·æ±‚ã€‚
